%%:uuid=180220171827001
#### nat: net address translation
- 我们内网某一台主机通过路由器向外网的服务器发起请求: 通过路由器,转发到外网服务器是没问题,那么外网服务器是没办法直接响应私网(内网)IP地址的;外网服务器的回应是无法通过外网路由送回给内网的主机的.
- 内网的主机访问互联网常见的两种方式:
    - 在网络层: nat,让私网地址的客户端经过地址转换以后,访问互联网上的主机, nat早期所要实现的目的不是为了让你访问互联网,而是为了安全性,隐藏本地主机. 通常在应用层或者传输层实现。
    - proxy: 代理, 通常是在应用层实现的,通常对于某一个特定应用的求情
##### nat的工作方式:
    1. SNAT: 只修改请求报文的源地址,一般是内网的主机访问外网的服务器;iptables实现SNAT功能,只需要在nat表的POSTROUTING链上添加一条规则即可
    2. DNAT: 只修改请求报文的目标地址,一般是外网的主机访问内网的服务器;iptables实现DNAT功能,要在nat表的PREROUTING链上添加一条规则
- 注意DNAT和REDIRECT的区别:
    1. REDIRECT 只适用于本机内部不同端口之间转发,本机请使用redirect以提高性能.
    2. DNAT用在PREROUTING链上,且用于不同主机间转发
- SNAT: 当客户端发出请求时,到达我们的目标服务器主机,目标主机在收到请求后会经由网关(NAT Server: 根据用户请求修改地址的规则而已)向外发送;当用户请求到达这台主机的时候,再向外转发时候,这个请求的原地址就会转换成与外网通信的IP地址,同理服务器响应的地址也需要转换.
- PNAT: 端口地址转发,也叫端口映射
- nat 实现方式
    ```
    // 假设我们nat服务器有两个IP,一个是内网IP 192.168.88.123, 另一个是外网的IP 172.16.100.9;实现SNAT
    1. 首先在nat服务器上,打开ip转发
    ~]# vi /etc/sysctl.conf (C7 是/etc/sysctl.d/99-sysctl.conf)
        net.ipv4.ip_forward = 1
    2. 在nat服务器上增加SNAT规则,把内网主机的SIP全部改为nat服务器外网IP地址
    ~]# iptables -t nat -A POSTROUTING -s 192.168.88.0/24 ! -d 192.168.88.0/24 -j SNAT --to-source 172.16.100.9 //把192.168.88.0内网的ip地址访问非网内的主机时, 把SOURCE IP全部转化成 172.16.100.9
    
    // 反转一下,让外网的主机来访问内网的192.168.88.123
    1. 首先在nat服务器上,打开ip转发
    ~]# vi /etc/sysctl.conf (C7 是/etc/sysctl.d/99-sysctl.conf)
        net.ipv4.ip_forward = 1
    2. 在nat服务器上增加DNAT规则,把外网主机的DIP全部改为nat服务器内网IP地址
    ~]# iptables -t nat -A PREROUTING -d 172.16.100.9 -p tcp --dport 80 -j DNAT --to-destination 192.168.88.123:80  //注意这里只转发了http服务
    
    // PNAT实现,假如我们web服务器的监听端口是8080,我想让别人通过80端口访问
    1. 首先在nat服务器上,打开ip转发
    ~]# vi /etc/sysctl.conf (C7 是/etc/sysctl.d/99-sysctl.conf)
        net.ipv4.ip_forward = 1
    2. 在nat服务器上增加PNAT规则,把外网主机的DIP全部改为nat服务器内网IP地址
    ~]# iptables -t nat -A PREROUTING -d 172.16.100.9 -p tcp --dport 8080 -j DNAT --to-destination 192.168.88.123:80 
    ```
- 地址伪装: 我们个人的网络IP是动态的经常变,那么我们有什么办法来搞定呢?
    ```
    // 内网机器要访问外网
    ~]# iptables -t nat -A POSTROUTING -s 192.168.88.0/24 ! -d 192.168.88.0/24 -j MASQUERADE    //地址伪装
    ```

