%%:uuid=180212001454001
### iptables
#### firewall: 防火墙就是隔离工具
- 防火墙工作于主机或网络的边缘,对于进出本主机或网络的报文根据事先定义的检测的规则做匹配检测,对于那些能够被规则所匹配到的报文做出相对应的处理的组件,可以是硬件,也可以是软件,也可以是二者的结合.
- 防火墙通常用的有两类:
    1. 主机防火墙: 放在内核空间的TCP/IP的协议栈上
    2. 网络防火墙: 
####主机防火墙
- 防火墙的功能不仅仅是"防火",还有其他一些附加功能,比如:
    - nat: 网络地址转换,改端口ip地址或者目标ip地址
    - pat: 端口地址转换
- 上面的报文对应内容的修改应该在规则检查之前进行操作,一旦报文到达本机内部了,再修改就来不及了
#### 网络防火墙
#### IPS intrusion protection system 入侵防御系统
- 首先由入侵检测系统IDS(intrusion detecting system)发现了某个用户有不轨行为,立马通知给firewall,firewall自动生成一个针对性的规则,把这种具有潜在攻击性的报文拒之门外,这种IDS和防火墙联动的模式就叫IPS;__注意,不是所有的IDS都可以和防火墙联动的,我们可以让它给管理员发邮件__
-  IDS分为HIDS(主机入侵检测系统,在主机上部署即可)和NIDS(网络入侵系统,要在网络中的多个位置部署传感器),可以在每一个关键性的服务器之前的任何报文进出位置部署一个Sensor,入侵检测系统和入侵防御系统也只有在用户发出攻击行为之后才能做出反应.
- Honeypot,可以在网络中的某些主机上专门部署一些伪装很巧妙的,有意漏出一些破绽引诱攻击
#### Iptables:包过滤型防火墙
- iptables的全称其实是iptables/netfilter;是一个内核中的网络报文处理框架;由它提供了hook functions(一些钩子函数);有了钩子只是把报文勾起来,但是这个报文到底符不符合匹配规则,如果符合,我们要做什么样的处理.所以规则才是检查并完成防火功能的组件;这个规则必须放在恰当位置才能发挥作用.
- Iptables就是负责向钩子上添加修改删除规则的工具;是一个工作在用户空间的工具.iptables 制定的规则,扔到内核上去,就会立即产生效果(临时生效);要想永久生效,就要写成脚本(配置文件)
- 防火墙不是什么服务(不会启动进程);但是为了方便理解,Centos6之前还是成为服务;它的启动过程其实就是再加载一遍 iptables的配置文件
- iptables的前生:`ipfw--> ipchains(ip链) --> iptables`; 之所以叫表是因为功能的多样化:
    - filter: 过滤,防火墙
    - nat: network address translation, 网络地址转换非常重要
    - mangle: 拆封报文,做出修改,重新封装
    - raw: 此功能用的不多,关闭nat表上启用的连接追踪机制(这个功能非常有用;就是识别之前来访问过本机的家伙);非常消耗内存,所以对于非常非常繁忙的前端服务器,连接追踪是万万不能开启的;会导致大量连接被拒绝
##### iptables的5个钩子函数
- 5个链(钩子的引用名称):
    1. PREROUTING: 路由前;和从哪块网卡进来或者离开没有任何关系,可以从任何网卡进来或离开
    2. INPUT:一旦pretouting结束了,我们的报文有两个走向之一:本机内部
    3. FORWARD:一旦pretouting结束了,我们的报文有两个走向之二:经由本机转发
    4. OUTPUT: 由本机发出的报文
    5. POSTROUTING: 路由决策发出决定以后,我们要对它即将离开的最后一关再做一些处理;和从哪块网卡进来或者离开没有任何关系,可以从任何网卡进来或离开
- 报文大概有三种:
    - 流入: 进入本机内部的: `PREROUTING --> INPUT`
    - 流出: 由本机发出的: `OUTPUT --> POSTROUTING` 
    - 转发: 由本机进来,又由本机发出的: `PREROUTING --> FORWARD --> POSTROUTING`
- 各功能的分别实现位置,每个位置一张表:
    - filter: 既不能做早,也不能做晚 只能在 INPUT, FORWARD和OUTPUT实现
    - nat: PREROUTING(DNAT), OUTPUT和 POSTROUTING(SNAT)
    - mangle: PREROUTING, INPUT, FORWARD, OUTPUT和POSTROUTING
    - raw: 通常在PREROUTING和 OUTPUT
- 路由发生的时刻:
    - 报文进入本机后:判断目标主机
    - 报文发出之前:判断经由哪个接口送往下一刻
- iptables共有___四表五链___:添加规则时的考量点:
    1. 要实现哪种功能: 判断添加在哪张表上
    2. 报文流经的路径: 判断添加在哪个链上
- 链上规则的次序,即为检查的次序,因此隐含一定的法则:
    1. 同类规则(访问同一应用),匹配范围小的放上面:
        ```
        Example:
        对22号端口进行检查: 来自192.168.0.0网络的主机放行,但是禁止192.168.0.88主机访问,那么就应该把"禁止192.168.0.88主机访问"的规则放在上面,因为,如果"来自192.168.0.0网络的主机放行"在上面的话,iptables可能就只看这一条不看下面的规则了,那么就造成了下面的"禁止192.168.0.88主机访问"就直接失效了
        ```
    2. 不同类规则(访问不同应用),匹配到报文频率较大的放上面
    3. 将那些可由一条规则描述的多个规则合并为一个
    4. 设置默认策略:
        - 白名单: 默认为拒绝,只对白名单里的开放
        - 黑名单: 默认为允许,支拒绝黑名单里的
- 功能的优先级次序:`raw --> mangle --> nat --> filter`
- 规则: 报文的匹配条件,匹配到之后的处理动作
- 匹配条件: 根据协议报文特征指定匹配条件;常用机制:
    - 基本匹配条件: 源IP, 目标IP, 源端口, 目标端口
    - 扩展匹配条件: 检查应用程序的特性
- 处理动作:
    - 内建处理机制
    - 自定义处理机制
- 注意事项: 报文不会经过自定义链,只能在内置链上通过规则引用后生效
#### iptables规则编写