%%:uuid=180129152052002
### rsyslog
#### 日志系统:syslog
- Linux上的日志系统: syslog(RHEL5),syslog-ng(ng: next generation,分为开源和商业版;RHEL6用的就是ng)
    - 信息的详细程序,日志级别声明不同的日志信息
    - 子系统:facility,设施设备.
    - 动作
- syslog服务有两个进程:
    - syslogd:负责记录非内核的其他设施所产生的日志
    - klogd:专门负责内核所产生的日志;所记录的日志的详细程度和 syslogd不一样,格式也不一样.
    - 在系统启动init之后,日志就交由syslogd来记录,之前则是有klogd记录
- 查看内核所产生的数值信息可以用`cat /var/log/dmesg`或者直接用命令`dmesg`查看.
- rsyslog: 在CentOS6上syslog升级成为了rsyslog,它有以下特性:
    - 多线程: 由于需要记录日志的服务越来越多,而且syslog不但能为本机进程记录日志,还能为非本机的进程来接受记录日志
    - 支持TCP/UDP协议,还能支持SSL,TLS进行加密完成远程日志传输(不过一般都是内网传输,用到的不多)
    - 还支持在MySQL,PGSQL等开源关系型数据库系统中记录日志:就是把日志放置在数据库中
    - 现在有很多日志由于量非常大,都是通过分布式存储的,有的用的是非关系型数据库存储的,
- 比如现在有一个著名的强大的分布式存储系统elasticsearch,它允许用户收集日志以后,把日志导入到elasticsearch的分布式存储系统中,它还能实现高效的查询引擎.它还需要一个日志收集工具,常用的是Logstash.收集完存储在elasticsearch中,但是elasticsearch是一个命令行接口,并不是所有用户能通过命令行写搜索法则,所以我们需要一个前端战士工具,常用的是kibana,三者结合起来常被称为ELK
- 日志:
    - /var/log/messages: 系统标准错误日志信息,记录的日志是非常详细的,一般非内核产生的引导信息都在这头; 各子系统产生的信息也在这里头.
    - 日志滚动(分割): 我们可以按照日志大小,时间;或者两者一起使用来切割日志,`logrotate`:滚动压缩,或者发送日志;系统上有个专门的计划任务能够完成日志滚动,在/etc/cron.daily(RHEL5)[/etc/cron.daily/logrotate(RHEL6)]
    - /var/log/maillog: 邮件系统产生的日志信息
    - /var/log/secure: 跟安全相关的,权限是600
- syslogd的配置文件在/etc/syslog.conf
- 配置文件定义格式为: facility.priority   action;facility,可以理解为日志的来源或设备(形象的可以称为日志收集器,比如把登录和ssh的日志都归结到认证相关的额),目前常用的facility有以下几种： 
    - auth      			\# 认证相关的 
    - authpriv  			\# 权限,授权相关的 
    - cron      			\# 任务计划相关的 
    - daemon    			\# 守护进程相关的 
    - kern      			\# 内核相关的 
    - lpr      			 \# 打印相关的 
    - mail     			 \# 邮件相关的 
    - mark     			 \# 标记相关的 
    - news     			 \# 新闻相关的 
    - security 			\# 安全相关的,与auth 类似  
    - syslog  			 \# syslog自己的 
    - user    			 \# 用户相关的 
    - uucp    			 \# unix to unix cp 相关的 
    - local0 到 local7 	\# 用户自定义使用 
    - `*`        			\# `*`表示所有的facility 
 
 - priority(log level)日志的级别,一般有以下几种级别(从低到高) 
    - debug           \# 程序或系统的调试信息,事无巨细,只要有信息就记录
    - info            \# 一般信息
    - notice          \# 不影响正常功能,需要注意的消息 
    - warning/warn    \# 可能影响系统功能,需要提醒用户的重要事件 
    - err/error       \# 错误信息 
    - crit            \# 比较严重的,蓝色警报
    - alert           \# 必须马上处理的,橙色警报
    - emerg/panic     \# 会导致系统不可用的,红色警报
    - `*`               \# 表示所有的日志级别 
    - none            \# 跟`*` 相反,表示啥也没有, 也就是不记录任何日志
    - 具体的某个级别    \# 表示记录此级别及更改级别的日志信息
    - =具体的某个级别     \#只记录此级别
     
 - action(动作)日志记录的位置 
    - 系统上的绝对路径    \# 普通文件 如： /var/log/xxx 
    - |                   \# 管道  通过管道送给其他的命令处理 
    - 终端              \# 终端   如：/dev/console 
    - @HOST               \# 远程主机 如： @10.0.0.1      
    - 用户              \# 系统用户 如： root 
    - \*                   \# 登录到系统上的所有用户，一般emerg级别的日志是这样定义的;也可以理解为发送给所有用户
    - 在动作前面有\- 的, 表示异步写入; 没有\- 表示同步写入.

- 定义格式例子：
    ``` 
    mail.info   /var/log/mail.log # 表示将mail相关的,级别为info及 
                                  # info以上级别的信息记录到/var/log/mail.log文件中 
    auth.=info  @10.0.0.1         # 表示将auth相关的,基本为info的信息记录到10.0.0.1主机上去 
                                  # 前提是10.0.0.1要能接收其他主机发来的日志信息 
    user.!=error                  # 表示记录user相关的,不包括error级别的信息 
    user.!error                   # 与user.error相反 
    *.info                        # 表示记录所有的日志信息的info级别 
    mail.*                        # 表示记录mail相关的所有级别的信息 
    *.*                           # 你懂的. 
    cron.info;mail.info           # 多个日志来源可以用";" 隔开 
    cron,mail.info                # 与cron.info;mail.info 是一个意思 
    mail.*;mail.!=info            # 表示记录mail相关的所有级别的信息,但是不包括info级别的 
    ```
- 一般syslog不能重启,一般都是用的`service syslog reload`  
- rsyslog 是一个程序包,`rpm -ql rsyslog`可以看到主配置文件是`/etc/rsyslog.conf`; 对应的还有很对的.so结尾的功能扩展模块,其中i开头的模块表示input,收集(接受日志)的; o开头的则表示output
- 