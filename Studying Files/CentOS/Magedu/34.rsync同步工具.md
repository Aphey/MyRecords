### rsync数据同步工具

#### 我们以前两台机器的同步方法
>1. scp命令
>2. nfs
>3. sftp
>4. samba共享

- rsync开源,快速,多功能的可以实现增量及全量的数据同步备份工具
- rsync服务场景:
  1. 两台服务器之间数据的同步
  2. 把所有客户服务器数据同步到备份服务器,生产场景集群架构服务器备份方案
- rsync的工作方式
  1. 单个主机本机之间的数据传输(类似于cp命令的功能)
  2. 借助rcp,ssh等通道的方式传输数据(类似于scp命令的功能)
  3. 以守护进程(socket)的方式传输数据(rsync自身的重要功能)
- rsycn的命令:`rsync [OPTIONS]... SRC... [DEST]`,rsync最常用的选项是-avz
  ```
  1. 直接本地同步,把/etc/hosts 备份到/tmp目录下
  [root@vm1 ~]# rsync -avz /etc/host
  host.conf    hosts        hosts.allow  hosts.deny
  [root@vm1 ~]# rsync -avz /etc/hosts /tmp
  sending incremental file list
  hosts

  sent 124 bytes  received 31 bytes  310.00 bytes/sec
  total size is 158  speedup is 1.02

  2. 删除/data/目录下的文件
  [root@vm1 ~]# ls /data
  abc  bbs
  [root@vm1 ~]# mkdir /null //新建一个空目录/null
  [root@vm1 ~]# ls /null

  [root@vm1 ~]# rsync -r --delete /null/ /data/
  //这里的/null/后面的/不可以省略,-r表示递归,--delete表示,我/null/里没有的而/data/里有的也给你删掉
  [root@vm1 ~]# ls /data  // /data里已经清空了

  3. rsync借助ssh通道从远端主机拉去数据的例子
  [root@vm1 ~]# rsync -avzP -e 'ssh -p 2222' root@192.168.1.32:/root/rsynctest /tmp
  root@192.168.1.32's password:
  receiving incremental file list
  rsynctest
             0 100%    0.00kB/s    0:00:00 (xfer#1, to-check=0/1)

  sent 30 bytes  received 75 bytes  42.00 bytes/sec
  total size is 0  speedup is 0.00
  [root@vm1 ~]# ls /tmp //文件已经拉取过来了
  hosts  rsynctest
  // avz表示同步时保持文件和目录的属性不变.
  // -P 表示显示同步过程,等同于--progress
  // -e 'ssh -p 2222',表示通过ssh通道传输数据,-p 22 则可以省略

  4. 通过ssh通道向局域网内的其他主机推送文件
  [root@vm1 ~]# rsync -avz /etc/hosts -e 'ssh -p 3333' root@192.168.1.33:/tmp
  root@192.168.1.33's password:
  sending incremental file list
  hosts

  sent 124 bytes  received 31 bytes  34.44 bytes/sec
  total size is 158  speedup is 1.02

  //到vm3上去查看是否推送成功
  [root@vm3 ~]# cd /tmp
  [root@vm3 tmp]# ls  //成功获取了vm1上的/etc/hosts文件
  hosts
  ```
#####通过守护进程模式来传输(socket)
- 准备三台机器
- 多台机器(vm1,vm2)往一台机器(vm3)上备份
- rsync的配置文件:/etc/rsyncd.conf,一开始是没有的,要手动创建
```
[root@vm3 ~]# vi /etc/rsyncd.conf //可以man rsync.conf

#rsync_config_______________start
#created by oldboy 15:01 2007-6-5
#QQ 31333741 blog:http://oldboy.blog.51cto.com
##rsyncd.conf start##
uid = rsync   //不指定用户的话,会是nobody
gid = rsync
use chroot = no   //禁用chroot
max connections = 200   //最大连接数
timeout = 300   //超时时间
pid file = /var/run/rsyncd.pid  //pid文件
lock file = /var/run/rsync.lock //lock文件
log file = /var/log/rsyncd.log  //log文件位置
[oldboy]    //模块
path = /oldboy/   //目录
ignore errors
read only = false   //是否只读,这里表示可写
list = false      //不允许列表
hosts allow = 192.168.1.0/24
hosts deny = 0.0.0.0/32
auth users = rsync_backup   //授权用户
secrets file = /etc/rsync.password  //授权用户的密码
#rsync_config_______________end
```
- 在vm3上启动rsync
```
[root@vm3 rsync]# rsync --daemon
[root@vm3 rsync]# ss -tlunp|grep :873 //rsync daemon的默认端口是873
tcp    LISTEN     0      5                     :::873                  :::*      users:(("rsync",16277,5))
tcp    LISTEN     0      5                      *:873                   *:*      users:(("rsync",16277,4))
[root@vm3 rsync]# useradd rsync -s /sbin/nologin    //创建系统用户rsync
[root@vm3 rsync]# chown -R rsync.rsync /rsync       //改变用来同步的目录的属主和属组
[root@vm3 rsync]# echo "rsync_backup:123456" > /etc/rsync.password  //把上面配置文件中的授权用户和对应密码放到授权用户的文件中去
[root@vm3 rsync]# cat /etc/rsync.password   //查看授权用户文件,用户名和密码用":"隔开
rsync_backup:123456
[root@vm3 rsync]# chmod 600 /etc/rsync.password   //降低授权用户的文件
[root@vm3 rsync]# service iptables stop   //关掉防火墙
iptables: Setting chains to policy ACCEPT: filter          [  OK  ]
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Unloading modules:                               [  OK  ]
[root@vm3 rsync]# getenforce  //关掉selinux
Permissive
// 到此为止,服务端配置完毕
```
- 配置客户端
```
[root@vm1 ~]# rpm -qa rsync   //确保客户机上安装了rsync
rsync-3.0.6-9.el6_4.1.x86_64
[root@vm1 ~]# echo "123456" > /etc/rsync.password //将服务器上的授权用户密码输入到/etc/rsync.password
[root@vm1 ~]# chmod 600 /etc/rsync.password
```
- 以后所有rsync命令都是在客户端执行的
```
// 从服务器拉取文件
[root@vm1 ~]# rsync -avz rsync_backup@192.168.1.33::oldboy /tmp //注意oldboy是服务器配置中的模块名,前面有两个冒号
Password:   //输入123456
receiving incremental file list
./
a
b
c
d
e

sent 162 bytes  received 328 bytes  108.89 bytes/sec
total size is 0  speedup is 0.00
//我们可以在命令中指定授权用"--password-file=/etc/rsync.password" 指定密码文件,就可以免密码推拉了
[root@vm1 ~]# rsync -avz rsync_backup@192.168.1.33::oldboy /tmp --password-file=/etc/rsync.password
receiving incremental file list

sent 64 bytes  received 145 bytes  418.00 bytes/sec
total size is 0  speedup is 0.00
// 从客户机向服务器推送文件
[root@vm1 tmp]# mkdir rsync/  //在/tmp下创建rsync目录
[root@vm1 tmp]# ls
a  b  c  d  e  hosts  rsync  rsynctest
[root@vm1 tmp]# cd rsync
[root@vm1 rsync]# touch {1..10} //创建10个文件
[root@vm1 rsync]# ls
1  10  2  3  4  5  6  7  8  9
[root@vm1 rsync]# cd ..
[root@vm1 tmp]# rsync -avz rsync/ rsync_backup@192.168.1.33::oldboy --password-file=/etc/rsync.password //推送
sending incremental file list
./
1
10
2
3
4
5
6
7
8
9

sent 450 bytes  received 201 bytes  1302.00 bytes/sec
total size is 0  speedup is 0.00

//到服务器查看,已经推送成功了
[root@vm3 rsync]# ls
1  10  2  3  4  5  6  7  8  9  a  b  c  d  e
```
- 我们客户机推拉文件也可以用 rsync协议
```
//拉取文件:
  [root@vm1 rsync]# pwd
  /tmp/rsync
  [root@vm1 rsync]# rm -fr *     //先在客户机上删除同步目录下的文件

  // 再用下面的命令进行拉取文件,注意ip后面用/模块
  [root@vm1 rsync]# rsync -avz rsync://rsync_backup@192.168.1.33/oldboy . --password-file=/etc/rsync.password
  receiving incremental file list
  ./
  1
  10
  2
  3
  4
  5
  6
  7
  8
  9
  a
  b
  c
  d
  e

  sent 352 bytes  received 789 bytes  2282.00 bytes/sec
  total size is 0  speedup is 0.00
  [root@vm1 rsync]# ls
  1  10  2  3  4  5  6  7  8  9  a  b  c  d  e
// 推送文件
  [root@vm3 rsync]# rm -rf *  //服务器端线删除所有文件
  [root@vm3 rsync]# ls
  // 客户端进行推送
  [root@vm1 rsync]# rsync -avz . rsync://rsync_backup@192.168.1.33/oldboy --password-file=/etc/rsync.password
  sending incremental file list
  ./
  1
  10
  2
  3
  4
  5
  6
  7
  8
  9
  a
  b
  c
  d
  e

  sent 704 bytes  received 296 bytes  2000.00 bytes/sec
  total size is 0  speedup is 0.00

  //再到客户机查看, 推送成功了
  [root@vm3 rsync]# ls
  1  10  2  3  4  5  6  7  8  9  a  b  c  d  e
```
